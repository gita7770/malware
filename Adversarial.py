

pip install tensorflow numpy opencv-python

def fgsm_attack(model, images, labels, epsilon):
    images = tf.cast(images, tf.float32)
    with tf.GradientTape() as tape:
        tape.watch(images)
        predictions = model(images)
        loss = tf.keras.losses.categorical_crossentropy(labels, predictions)
    gradient = tape.gradient(loss, images)
    signed_grad = tf.sign(gradient)
    adversarial_images = images + epsilon * signed_grad
    adversarial_images = tf.clip_by_value(adversarial_images, 0, 1)  # Ensure the images are in [0, 1] range
    return adversarial_images
	
	
	
	def pgd_attack(model, images, labels, epsilon, alpha, iterations):
    images = tf.cast(images, tf.float32)
    original_images = images

    for i in range(iterations):
        with tf.GradientTape() as tape:
            tape.watch(images)
            predictions = model(images)
            loss = tf.keras.losses.categorical_crossentropy(labels, predictions)
        gradient = tape.gradient(loss, images)
        signed_grad = tf.sign(gradient)
        images = images + alpha * signed_grad
        perturbations = tf.clip_by_value(images - original_images, -epsilon, epsilon)
        images = tf.clip_by_value(original_images + perturbations, 0, 1)  # Ensure the images are in [0, 1] range

    return images
	
	
	
	if __name__ == "__main__":
    """ Seeding """
    np.random.seed(42)
    tf.random.set_seed(42)

    """ Paths """
    dataset_path = "/media/nikhil/Seagate Backup Plus Drive/ML_DATASET/flowers"
    model_path = os.path.join("files", "model.h5")

    """ Dataset """
    train_x, valid_x, test_x = load_data(dataset_path)
    print(f"Train: {len(train_x)} - Valid: {len(valid_x)} - Test: {len(test_x)}")

    test_ds = tf_dataset(test_x, batch=hp["batch_size"])

    """ Model """
    model = ViT(hp)
    model.load_weights(model_path)
    model.compile(
        loss=tf.keras.losses.CategoricalCrossentropy(from_logits=False),
        optimizer=tf.keras.optimizers.Adam(hp["lr"]),
        metrics=["acc"]
    )

    # Evaluate the model on clean data
    print("Evaluating on clean data...")
    clean_loss, clean_acc = model.evaluate(test_ds)
    print(f"Clean data - Loss: {clean_loss}, Accuracy: {clean_acc}")

    # FGSM Attack Evaluation
    epsilon = 0.01
    print("Evaluating under FGSM attack...")
    fgsm_acc = tf.metrics.CategoricalAccuracy()

    for images, labels in test_ds:
        adv_images = fgsm_attack(model, images, labels, epsilon)
        predictions = model(adv_images)
        fgsm_acc.update_state(labels, predictions)
    
    print(f"FGSM attack - Accuracy: {fgsm_acc.result().numpy()}")

    # PGD Attack Evaluation
    epsilon = 0.01
    alpha = 0.001
    iterations = 40
    print("Evaluating under PGD attack...")
    pgd_acc = tf.metrics.CategoricalAccuracy()

    for images, labels in test_ds:
        adv_images = pgd_attack(model, images, labels, epsilon, alpha, iterations)
        predictions = model(adv_images)
        pgd_acc.update_state(labels, predictions)
    
    print(f"PGD attack - Accuracy: {pgd_acc.result().numpy()}")



